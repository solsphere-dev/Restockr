# .github/workflows/release.yml
# Purpose: bump TOC version and create a clean GitHub Release asset only.
# CurseForge packaging is left to the project webhook.
name: release
on:
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build-github-asset:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Sync TOC version from tag
        shell: bash
        run: |
          set -euo pipefail
          ver="${GITHUB_REF_NAME#v}"
          toc="$(ls *.toc | head -n1)"
          awk -v v="$ver" 'BEGIN{d=0}
            /^\s*##\s*Version\s*:/ {print "## Version: " v; d=1; next}
            {print}
            END{if(!d)print "## Version: " v}' "$toc" > "$toc.tmp"
          mv "$toc.tmp" "$toc"
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "$toc" && git commit -m "CI: set TOC to $ver" || true

      - name: Make clean zip for GitHub (exclude tools/scripts/repo junk)
        shell: bash
        run: |
          set -euo pipefail
          name="$(basename "$PWD")"
          out="dist"; mkdir -p "$out"
          zip="${out}/${name}-${GITHUB_REF_NAME#v}.zip"
          rm -f "$zip"

          stage="$(mktemp -d)"; mkdir -p "$stage/$name"
          rsync -a ./ "$stage/$name"/ \
            --exclude '.git/**' \
            --exclude '.github/**' \
            --exclude '.vscode/**' \
            --exclude 'dist/**' \
            --exclude 'tools/**' \
            --exclude '*.ps1' \
            --exclude '*.bat' \
            --exclude '*.zip' \
            --exclude 'README.md' \
            --exclude 'LICENSE'

          (cd "$stage" && zip -r9 "$OLDPWD/$zip" "$name" >/dev/null)
          rm -rf "$stage"
          echo "ZIP=$zip" >> $GITHUB_ENV

      - name: Verify no forbidden content made it into the GitHub zip
        shell: bash
        run: |
          set -euo pipefail
          unzip -l "$ZIP" | grep -Eiq '/tools/|\.ps1$|\.bat$|^ *[0-9]+ +\.git/' && {
            echo "::error::Forbidden files found in $ZIP"
            unzip -l "$ZIP" | grep -Ei '/tools/|\.ps1$|\.bat$|^ *[0-9]+ +\.git/'
            exit 1
          }

      - name: Create GitHub Release (attach zip)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Restockr ${{ github.ref_name }}
          files: ${{ env.ZIP }}
          overwrite: true
          prerelease: ${{ startsWith(github.ref_name, 'v0.') || contains(github.ref_name, '-beta') }}
